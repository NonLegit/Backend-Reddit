pipeline {
    agent any
    stages {
        stage('Upgrading mockserver') {
            when {
                branch "API_documentation"
            }
            environment {
                    AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
                    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
            }
            steps {
                    sh '''
                            export AWS_ACCESS_EY=$AWS_ACCESS_KEY_ID
                            sleep 600
                    '''
            }
        }
        stage('Building backend') {
            when {
                    branch "development"
            }
            environment {
                    GIT_PASSWORD = credentials('github-pat')
                    DB_PASSWORD = credentials('db-password')
                    DB_USER = credentials('db-user')
                    EMAIL_PASSWORD = credentials('email-password')
                    DOCKER_USERNAME = credentials('docker-username')
                    DOCKER_PASSWORD = credentials('docker-password')
            }
            steps {
                    sh '''
                        cd API
                        # Set up git credentials.
                        if [ ! -f "/var/jenkins_home/git-askpass-helper.sh" ]; then
                            echo "#!/bin/bash" >> /var/jenkins_home/git-askpass-helper.sh
                            echo 'exec echo $GIT_PASSWORD' >> /var/jenkins_home/git-askpass-helper.sh
                            chmod +x /var/jenkins_home/git-askpass-helper.sh
                        fi

                        export GIT_ASKPASS=/var/jenkins_home/git-askpass-helper.sh
                        export GIT_PASSWORD=$GIT_PASSWORD
                        export DB_PASSWORD=$DB_PASSWORD
                        export DOCKER_PASSWORD=$DOCKER_PASSWORD
                        export DOCKER_USERNAME=$DOCKER_USERNAME
                        export DB_USER=$DB_USER
                        export EMAIL_PASSWORD=$EMAIL_PASSWORD

                        # Getting the backend Dockerfile
                        git clone https://cynico@github.com/NonLegit/devops.git
                        cp devops/dockerfiles/backend/Dockerfile devops/docker-compose/backend/docker-compose.yaml .
                        rm -rf devops

                        # Modify the necessary files.
                        sed -i 's/<USER>/$DB_USER/g;s/<PASSWORD>/$DB_PASSWORD/g;s/<EMAIL_PASSWORD>/$EMAIL_PASSWORD/g' config/config.env package.json

                        # Build the docker image
                        docker build -t cynic0/reddit-backend:latest . 

                        # Push the docker image.
                        docker login --username $DOCKER_USERNAME --password $DOCKER_PASSWORD
                        docker push cynic0/reddit-backend:latest

                        # Stop the docker compose.
                        docker compose down

                        # Restart docker compose
                        docker compose up -d
                    '''
            }
        }
        stage('Deploying backend') {
            when {
                    branch "development"
            }
            steps {
                echo xd
            }
        }
    }
}
